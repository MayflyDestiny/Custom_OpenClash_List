name: Purge jsDelivr Cache (rule folder only)

on:
  workflow_run:
    workflows: ["Auto generate rules"]
    types:
      - completed

jobs:
  purge:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Collect changed rule files
        id: files
        run: |
          HEAD_SHA="${{ github.event.workflow_run.head_sha }}"
          git fetch origin main
          mapfile -t FILES < <(git diff --name-only HEAD~1 "$HEAD_SHA" | grep -E '^rule/.*\.(list|yaml|mrs)$' || true)
          if [[ ${#FILES[@]} -eq 0 ]]; then
            echo "should_purge=false" >> "$GITHUB_OUTPUT"
          else
            printf "%s\n" "${FILES[@]}" > changed_files.txt
            echo "should_purge=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Purge jsDelivr Cache
        if: steps.files.outputs.should_purge == 'true'
        run: |
          REPO="${{ github.repository }}"
          while IFS= read -r file; do
            CDN_URL="https://cdn.jsdelivr.net/gh/${REPO}@main/${file}"
            PURGE_URL="https://purge.jsdelivr.net/gh/${REPO}@main/${file}"

            echo "Waiting for $file to be available on jsDelivr..."
            for i in {1..10}; do
              http_code=$(curl -s -o /dev/null -w "%{http_code}" "$CDN_URL")
              [[ "$http_code" == "200" ]] && break
              echo "  $i/10  CDN not ready yet, wait 5s..."
              sleep 5
            done

            echo "Purging $file ..."
            for i in {1..3}; do
              resp=$(curl -s -w "%{http_code}" -o purge.json "$PURGE_URL")
              if [[ "$resp" == "200" ]] && grep -q '"status":"finished"' purge.json; then
                echo "✅ $file purged"
                break
              else
                echo "⚠️  purge attempt $i failed, retry in 5s..."
                sleep 5
              fi
              [[ $i -eq 3 ]] && echo "❌ $file purge failed finally"
            done
          done < changed_files.txt