name: Auto generate rules
on:
  push:
    paths:
      - 'rule/*.list'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  generate-rules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      - name: Set Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
      - name: Download mihomo
        run: |
          MIHOMO_VERSION="v1.19.18"
          echo "Downloading mihomo ${MIHOMO_VERSION}..."
          wget -q "https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          gunzip "mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          chmod +x "mihomo-linux-amd64-${MIHOMO_VERSION}"
          sudo mv "mihomo-linux-amd64-${MIHOMO_VERSION}" /usr/local/bin/mihomo
          echo "mihomo ${MIHOMO_VERSION} installed successfully"
      - name: Generate YAML from LIST files
        run: |
          FILES=("Custom_Check" "Custom_Direct" "Custom_Proxy" "Fakeip-Filter")
          for base_name in "${FILES[@]}"; do
            list_file="rule/${base_name}.list"
            yaml_file="rule/${base_name}.yaml"
            {
              echo "# Generated from ${list_file}"
              echo "# REPO: https://github.com/${{ github.repository }}"
              echo "# SOURCE: https://github.com/${{ github.repository }}/blob/main/${list_file}"
              echo "payload:"
              grep -E '^DOMAIN,' "$list_file" | sed "s/^DOMAIN,//" | sed "s/^/  - '/" | sed "s/$/'/" || true
              grep -E '^DOMAIN-SUFFIX,' "$list_file" | sed "s/^DOMAIN-SUFFIX,//" | sed "s/^/  - '+./" | sed "s/$/'/" || true
              grep -E '^DOMAIN-KEYWORD,' "$list_file" | sed "s/^DOMAIN-KEYWORD,//" | sed "s/^/  - '*/" | sed "s/$/*'/" || true
            } > "$yaml_file"
            if [[ -n $(git status --porcelain "$yaml_file") ]]; then
              git add "$yaml_file"
              git commit -m "chore(rules): auto generate $(basename "$yaml_file") from $(basename "$list_file")"
            else
              echo "No changes in ${yaml_file}, skip commit."
            fi
          done
      - name: Convert YAML to MRS
        run: |
          echo "Converting YAML files to MRS format..."
          for yaml_file in rule/*.yaml; do
            mrs_file="${yaml_file%.yaml}.mrs"
            echo "Converting $yaml_file to $mrs_file"
            mihomo convert-ruleset domain yaml "$yaml_file" "$mrs_file"
            if [ -f "$mrs_file" ]; then
              echo "✓ Generated $mrs_file"
              if [[ -n $(git status --porcelain "$mrs_file") ]]; then
                git add "$mrs_file"
                git commit -m "chore(rules): auto generate $(basename "$mrs_file") from $(basename "$yaml_file")"
              else
                echo "No changes in ${mrs_file}, skip commit."
              fi
            else
              echo "✗ Failed to generate $mrs_file"
              exit 1
            fi
          done
      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ -n $(git log origin/main..HEAD) ]]; then
            git push origin HEAD:main
          else
            echo "No new commits to push."
          fi